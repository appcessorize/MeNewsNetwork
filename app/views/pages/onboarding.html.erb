<% content_for(:title) { "Me News â€” Welcome" } %>

<style>
  #onboarding-scroller {
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-x;
    cursor: grab;
  }
  #onboarding-scroller > section {
    scroll-snap-align: start;
    scroll-snap-stop: always;
    flex: 0 0 100%;
    width: 100%;
    min-width: 100%;
    max-width: 100%;
  }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  #onboarding-scroller.is-dragging { cursor: grabbing; }
  body.no-select, body.no-select * {
    user-select: none;
    -webkit-user-select: none;
  }
  .chat-bubble-left {
    background: #e5e7eb;
    color: #1f2937;
    border-radius: 18px 18px 18px 4px;
  }
  .chat-bubble-right {
    background: #3b82f6;
    color: white;
    border-radius: 18px 18px 4px 18px;
  }
</style>

<div class="relative h-screen w-screen overflow-hidden" style="font-family: 'Inter', system-ui, -apple-system, sans-serif;">

  <main
    id="onboarding-scroller"
    class="no-scrollbar flex flex-row flex-nowrap h-screen w-screen overflow-x-auto overflow-y-hidden scroll-smooth"
    aria-label="Welcome to Me News"
  >

    <%# Screen 1: What is Me News %>
    <section class="h-screen shrink-0 flex items-center justify-center p-6 bg-gradient-to-br from-slate-800 to-slate-950">
      <div class="max-w-md w-full">
        <div class="card bg-base-100/90 shadow-xl">
          <div class="card-body">
            <h1 class="text-3xl font-black italic">Me News</h1>
            <p class="text-lg font-semibold text-primary mt-1">The first AI-powered Social Media</p>
            <p class="opacity-70 mt-4 leading-relaxed">
              Social media became just <em>media</em>. Me News brings it back to your friends.
            </p>
            <p class="opacity-70 mt-2 leading-relaxed">
              One daily episode for your group â€” not an endless feed of strangers.
            </p>
          </div>
        </div>
      </div>
    </section>

    <%# Screen 2: How it Works + Video %>
    <section class="h-screen shrink-0 flex items-center justify-center p-6 bg-gradient-to-br from-indigo-700 to-slate-950">
      <div class="max-w-md w-full">
        <div class="card bg-base-100/90 shadow-xl">
          <div class="card-body">
            <h2 class="text-2xl font-bold">How it works</h2>
            <ul class="mt-3 space-y-2">
              <li class="flex items-start gap-3">
                <span class="badge badge-primary badge-lg shrink-0">1</span>
                <span class="opacity-80">Share a video of something from your day</span>
              </li>
              <li class="flex items-start gap-3">
                <span class="badge badge-primary badge-lg shrink-0">2</span>
                <span class="opacity-80">AI turns it into a news story</span>
              </li>
              <li class="flex items-start gap-3">
                <span class="badge badge-primary badge-lg shrink-0">3</span>
                <span class="opacity-80">A personalised daily bulletin for your group</span>
              </li>
            </ul>
            <div class="mt-4 rounded-xl overflow-hidden bg-black" style="aspect-ratio: 9/16; max-height: 300px;">
              <iframe
                src="https://customer-umftpj9wolekeelh.cloudflarestream.com/b4db1f92c0ef358622add4241742aa4e/iframe?controls=true&autoplay=false&muted=true"
                style="border: none; width: 100%; height: 100%;"
                allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        </div>
      </div>
    </section>

    <%# Screen 3: Share / Join Group %>
    <section class="h-screen shrink-0 flex items-center justify-center p-6 bg-gradient-to-br from-emerald-700 to-slate-950">
      <div class="max-w-md w-full">
        <div class="card bg-base-100/90 shadow-xl">
          <div class="card-body">

            <%# Has group â€” show invite/share %>
            <div id="has-group-section" class="<%= @has_group ? '' : 'hidden' %>">
              <h2 class="text-2xl font-bold">Invite Your Friends</h2>
              <p class="opacity-70 mt-2">
                Share this link so friends can join
                <strong id="group-name-display"><%= @group&.name %></strong>
              </p>

              <div class="mt-4">
                <input
                  id="invite-url-input"
                  type="text"
                  readonly
                  value="<%= @invite_url %>"
                  class="input input-bordered w-full text-sm font-mono"
                  onclick="this.select()"
                />
              </div>

              <div class="flex flex-wrap gap-2 mt-4">
                <button id="btn-copy" type="button" class="btn btn-sm btn-outline gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                  Copy
                </button>
                <button id="btn-whatsapp" type="button" class="btn btn-sm btn-outline gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                  WhatsApp
                </button>
                <button id="btn-imessage" type="button" class="btn btn-sm btn-outline gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  iMessage
                </button>
                <button id="btn-share" type="button" class="btn btn-sm btn-outline gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                  Share
                </button>
              </div>
            </div>

            <%# No group â€” join or create %>
            <div id="no-group-section" class="<%= @has_group ? 'hidden' : '' %>">
              <h2 class="text-2xl font-bold">Join or Start a Group</h2>

              <div class="mt-4">
                <label class="label"><span class="label-text font-medium">Have an invite code?</span></label>
                <div class="flex gap-2">
                  <input
                    id="invite-code-input"
                    type="text"
                    placeholder="Paste invite link or code"
                    class="input input-bordered flex-1 text-sm"
                  />
                  <button id="btn-join" type="button" class="btn btn-primary btn-sm">Join</button>
                </div>
              </div>

              <div class="divider">OR</div>

              <div>
                <label class="label"><span class="label-text font-medium">Start your own group</span></label>
                <div class="flex gap-2">
                  <input
                    id="group-name-input"
                    type="text"
                    placeholder="Group name"
                    class="input input-bordered flex-1 text-sm"
                    value="<%= @user&.name ? "#{@user.name}'s Group" : '' %>"
                  />
                  <button id="btn-create-group" type="button" class="btn btn-primary btn-sm">Create</button>
                </div>
                <p id="create-group-error" class="text-error text-sm mt-1 hidden"></p>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <%# Screen 4: Get Started %>
    <section class="h-screen shrink-0 flex items-center justify-center p-6 bg-gradient-to-br from-sky-700 to-slate-950">
      <div class="max-w-md w-full">
        <div class="card bg-base-100/90 shadow-xl">
          <div class="card-body">
            <h2 class="text-2xl font-bold text-center">Your Daily News Awaits</h2>

            <%# Chat preview %>
            <div class="mt-4 space-y-3 px-1">
              <div class="flex gap-2 items-end">
                <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center shrink-0 text-lg">ðŸ¤–</div>
                <div class="chat-bubble-left px-4 py-2 text-sm max-w-[80%]">
                  Hey! What's been happening today? Share something with the group!
                </div>
              </div>

              <div class="flex gap-2 items-end justify-end">
                <div class="chat-bubble-right px-4 py-2 text-sm max-w-[80%]">
                  Just had the best coffee at this new place downtown â˜•
                </div>
              </div>

              <div class="flex gap-2 items-end">
                <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center shrink-0 text-lg">ðŸ¤–</div>
                <div class="chat-bubble-left px-4 py-2 text-sm max-w-[80%]">
                  That sounds great! Send a video or photo and I'll turn it into a story for the bulletin ðŸ“°
                </div>
              </div>
            </div>

            <div class="mt-6">
              <button id="btn-get-started" type="button" class="btn btn-primary btn-lg w-full">
                Get Started
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <%# Bottom Controls %>
  <footer class="fixed inset-x-0 bottom-0 p-4 z-40">
    <div class="mx-auto max-w-md">
      <div class="rounded-2xl bg-base-100/90 shadow-xl backdrop-blur px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2" aria-label="Page markers" id="onboarding-dots"></div>
        <button id="onboarding-next" class="btn btn-primary btn-sm">Next</button>
      </div>
    </div>
  </footer>
</div>

<script>
(function () {
  var scroller = document.getElementById('onboarding-scroller');
  var dots = document.getElementById('onboarding-dots');
  var nextBtn = document.getElementById('onboarding-next');
  if (!scroller || !dots || !nextBtn) return;

  var pages = Array.from(scroller.querySelectorAll('section'));
  var pageCount = pages.length;
  var csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

  // â”€â”€ Dots â”€â”€
  for (var i = 0; i < pageCount; i++) {
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-ghost btn-xs !px-2';
    btn.setAttribute('aria-label', 'Go to page ' + (i + 1));
    btn.setAttribute('data-page', String(i));
    btn.innerHTML = '<span class="inline-block h-2 w-2 rounded-full bg-base-content/30"></span>';
    btn.addEventListener('click', (function(idx) { return function() { scrollToPage(idx); }; })(i));
    dots.appendChild(btn);
  }

  function setActiveDot(index) {
    Array.from(dots.children).forEach(function(btn, i) {
      var dot = btn.querySelector('span');
      if (!dot) return;
      if (i === index) {
        dot.className = 'inline-block h-2 w-6 rounded-full bg-primary transition-all';
        btn.classList.add('btn-active');
      } else {
        dot.className = 'inline-block h-2 w-2 rounded-full bg-base-content/30 transition-all';
        btn.classList.remove('btn-active');
      }
    });
    nextBtn.textContent = index >= pageCount - 1 ? 'Done' : 'Next';
  }

  function currentIndexFromScroll() {
    var w = scroller.clientWidth || window.innerWidth;
    return Math.max(0, Math.min(pageCount - 1, Math.round(scroller.scrollLeft / w)));
  }

  function scrollToPage(index) {
    var clamped = Math.max(0, Math.min(pageCount - 1, index));
    var target = pages[clamped];
    if (target) target.scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
  }

  // â”€â”€ Next / Done button â”€â”€
  nextBtn.addEventListener('click', function() {
    var idx = currentIndexFromScroll();
    if (idx >= pageCount - 1) {
      completeOnboarding();
    } else {
      scrollToPage(idx + 1);
    }
  });

  // â”€â”€ Get Started button (screen 4) â”€â”€
  var getStartedBtn = document.getElementById('btn-get-started');
  if (getStartedBtn) {
    getStartedBtn.addEventListener('click', function() {
      completeOnboarding();
    });
  }

  // â”€â”€ Complete onboarding â”€â”€
  function completeOnboarding() {
    fetch('/onboarding/complete', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': csrfToken,
        'Content-Type': 'application/json'
      }
    }).then(function() {
      window.location.href = '/';
    }).catch(function() {
      window.location.href = '/';
    });
  }

  // â”€â”€ Share buttons â”€â”€
  var inviteInput = document.getElementById('invite-url-input');

  var copyBtn = document.getElementById('btn-copy');
  if (copyBtn) {
    copyBtn.addEventListener('click', function() {
      var url = inviteInput ? inviteInput.value : '';
      if (!url) return;
      navigator.clipboard.writeText(url).then(function() {
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
        setTimeout(function() {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> Copy';
        }, 2000);
      });
    });
  }

  var whatsappBtn = document.getElementById('btn-whatsapp');
  if (whatsappBtn) {
    whatsappBtn.addEventListener('click', function() {
      var url = inviteInput ? inviteInput.value : '';
      if (!url) return;
      var text = 'Join my group on Me News! ' + url;
      window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
    });
  }

  var imessageBtn = document.getElementById('btn-imessage');
  if (imessageBtn) {
    imessageBtn.addEventListener('click', function() {
      var url = inviteInput ? inviteInput.value : '';
      if (!url) return;
      var text = 'Join my group on Me News! ' + url;
      window.location.href = 'sms:&body=' + encodeURIComponent(text);
    });
  }

  var shareBtn = document.getElementById('btn-share');
  if (shareBtn) {
    shareBtn.addEventListener('click', function() {
      var url = inviteInput ? inviteInput.value : '';
      if (!url) return;
      if (navigator.share) {
        navigator.share({ title: 'Join Me News', text: 'Join my group on Me News!', url: url }).catch(function() {});
      } else {
        navigator.clipboard.writeText(url).then(function() {
          shareBtn.textContent = 'Copied!';
          setTimeout(function() { shareBtn.textContent = 'Share'; }, 2000);
        });
      }
    });
  }

  // â”€â”€ Join group â”€â”€
  var joinBtn = document.getElementById('btn-join');
  var inviteCodeInput = document.getElementById('invite-code-input');
  if (joinBtn && inviteCodeInput) {
    joinBtn.addEventListener('click', function() {
      var raw = inviteCodeInput.value.trim();
      if (!raw) return;
      // Extract token from a full URL or use as-is
      var token = raw;
      var match = raw.match(/\/join\/([A-Za-z0-9_-]+)/);
      if (match) token = match[1];
      window.location.href = '/join/' + encodeURIComponent(token);
    });
  }

  // â”€â”€ Create group â”€â”€
  var createBtn = document.getElementById('btn-create-group');
  var groupNameInput = document.getElementById('group-name-input');
  var createError = document.getElementById('create-group-error');
  if (createBtn && groupNameInput) {
    createBtn.addEventListener('click', function() {
      var name = groupNameInput.value.trim();
      if (!name) { groupNameInput.focus(); return; }

      createBtn.classList.add('loading');
      createBtn.disabled = true;
      createError.classList.add('hidden');

      fetch('/friends/create_group', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ name: name })
      })
      .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
      .then(function(res) {
        createBtn.classList.remove('loading');
        createBtn.disabled = false;

        if (!res.ok) {
          createError.textContent = res.data.error || 'Something went wrong';
          createError.classList.remove('hidden');
          return;
        }

        // Success â€” swap to has-group view
        document.getElementById('no-group-section').classList.add('hidden');
        var hasGroupSection = document.getElementById('has-group-section');
        hasGroupSection.classList.remove('hidden');

        document.getElementById('group-name-display').textContent = res.data.group.name;
        document.getElementById('invite-url-input').value = res.data.invite_url;
      })
      .catch(function() {
        createBtn.classList.remove('loading');
        createBtn.disabled = false;
        createError.textContent = 'Network error. Please try again.';
        createError.classList.remove('hidden');
      });
    });
  }

  // â”€â”€ IntersectionObserver for dot updates â”€â”€
  var io = new IntersectionObserver(function(entries) {
    var visible = entries
      .filter(function(e) { return e.isIntersecting; })
      .sort(function(a, b) { return b.intersectionRatio - a.intersectionRatio; })[0];
    if (!visible) return;
    var idx = pages.indexOf(visible.target);
    if (idx !== -1) setActiveDot(idx);
  }, { root: scroller, threshold: [0.5, 0.65, 0.8] });

  pages.forEach(function(p) { io.observe(p); });

  // Fallback scroll listener
  var scrollTimer = null;
  scroller.addEventListener('scroll', function() {
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(function() { setActiveDot(currentIndexFromScroll()); }, 80);
  }, { passive: true });

  // â”€â”€ Desktop drag-to-scroll â”€â”€
  var isDragging = false, dragStartX = 0, dragStartScrollLeft = 0, maxDragDelta = 0;

  scroller.addEventListener('pointerdown', function(e) {
    if (e.pointerType !== 'mouse' || e.button !== 0) return;
    if (e.target.closest('button,a,input')) return;
    isDragging = true;
    dragStartX = e.clientX;
    dragStartScrollLeft = scroller.scrollLeft;
    maxDragDelta = 0;
    scroller.classList.add('is-dragging');
    document.body.classList.add('no-select');
    scroller.style.scrollSnapType = 'none';
    try { scroller.setPointerCapture(e.pointerId); } catch(_) {}
  });

  scroller.addEventListener('pointermove', function(e) {
    if (!isDragging) return;
    var dx = e.clientX - dragStartX;
    maxDragDelta = Math.max(maxDragDelta, Math.abs(dx));
    scroller.scrollLeft = dragStartScrollLeft - dx;
    if (maxDragDelta > 4) e.preventDefault();
  });

  function endDrag(e) {
    if (!isDragging) return;
    isDragging = false;
    scroller.classList.remove('is-dragging');
    document.body.classList.remove('no-select');
    scroller.style.scrollSnapType = '';
    if (maxDragDelta > 6) scrollToPage(currentIndexFromScroll());
    try { scroller.releasePointerCapture(e.pointerId); } catch(_) {}
  }

  scroller.addEventListener('pointerup', endDrag);
  scroller.addEventListener('pointercancel', endDrag);
  scroller.addEventListener('lostpointercapture', endDrag);

  // â”€â”€ Keyboard nav â”€â”€
  window.addEventListener('keydown', function(e) {
    if (e.target.closest('input')) return;
    if (e.key === 'ArrowRight') scrollToPage(currentIndexFromScroll() + 1);
    else if (e.key === 'ArrowLeft') scrollToPage(currentIndexFromScroll() - 1);
  });

  setActiveDot(0);
})();
</script>
